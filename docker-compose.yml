version: '3.9'

services:
  temporalite:
    image: slamdev/temporalite:0.3.0
    ports:
      - 7233:7233
      - 8233:8233

  catalog:
    image: debezium/postgres:14-alpine
    ports:
      # mapping is from host to container
      - 5432:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      [
        "postgres",
        "-c",
        "log_statement=all",
        "-c",
        "log_destination=stderr"
      ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready",
          "-d",
          "postgres",
          "-U",
          "postgres"
        ]
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 60s

  flow_api:
    build:
      context: .
      dockerfile: stacks/flow-api.Dockerfile
    ports:
      - 8112:8112
    environment:
      CATALOG_DSN: postgres://postgres:postgres@catalog:5432/postgres?sslmode=disable
      TEMPORAL_HOST_PORT: temporalite:7233
    depends_on:
      - catalog
      - temporalite

  flow_worker:
    build:
      context: .
      dockerfile: stacks/flow-worker.Dockerfile
    environment:
      TEMPORAL_HOST_PORT: temporalite:7233
    depends_on:
      - temporalite

  peerdb:
    build:
      context: .
      dockerfile: stacks/nexus.Dockerfile
    environment:
      PEERDB_LOG_DIR: /var/log/peerdb
      PEERDB_CATALOG_HOST: catalog
      PEERDB_CATALOG_PORT: 5432
      PEERDB_CATALOG_USER: postgres
      PEERDB_CATALOG_PASSWORD: postgres
      PEERDB_CATALOG_DB: postgres
      PEERDB_PASSWORD: peerdb
      PEERDB_FLOW_SERVER_ADDRESS: http://flow_api:8112
    ports:
      - 9900:9900
    depends_on:
      - catalog
      - flow_api
