name: Docker images

on: 
  push:
    branches: [master, stable]
    tags:
      - 'v[0-9]+.[0-9]+'

jobs:

  checkout:
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_CHECKOUT }}

  login:
    runs-on: ubuntu-latest
    steps:
      - name: 'Login to GitHub Container Registry'
        uses: docker/login-action@v2.1.0
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GITHUB_TOKEN}}

  dev-build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/head/master'
      - name: Build dev image
        uses: .github/workflows/image.yml
        with:
          tags: peerdb-server:dev
    
  latest-build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/head/stable'
    steps:
      - name: Build stable image
        uses: .github/workflows/image.yml
        with:
          tags: peerdb-server:latest
    
  tag-build:
    runs-on: ubuntu-latest  
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: "Get tag"
        run: "echo \"RELEASE_TAG=${GITHUB_REF#refs/tags/}\" >> $GITHUB_ENV"

      - name: Build tag image
        uses: .github/workflows/image.yml
        with:
          tags: 'peerdb-server:${{ process.env.RELEASE_TAG }}'